<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Nightwolf Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --bg: #0f172a; --panel: #1e293b; --accent: #ec4899; --text: #f1f5f9; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; display: grid; gap: 20px; }
    .card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
    h2 { margin-top: 0; color: var(--accent); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: #38bdf8; }
    
    .player-ui { text-align: center; }
    .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s linear; }
    
    input, button, select { padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; }
    button { background: var(--accent); border: none; cursor: pointer; font-weight: bold; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    textarea { width: 100%; height: 200px; background: #000; color: #0f0; border: none; padding: 10px; font-family: monospace; }
  </style>
</head>
<body>

<div class="container">
  <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>üê∫ Nightwolf Entertainments</h1>
    <div id="loginArea">
      <input type="password" id="apiKey" placeholder="Passwort" />
      <button onclick="login()">Login</button>
    </div>
    <div id="statusArea" style="display:none; color:#4ade80">‚óè Verbunden</div>
  </div>

  <div class="card" id="mainUI" style="display:none;">
    <h2>System (Bot Container)</h2>
    <div class="stats-grid">
      <div class="stat-box">Bot RAM: <div class="stat-val" id="ramVal">-</div></div>
      <div class="stat-box">CPU Load: <div class="stat-val" id="cpuVal">-</div></div>
      <div class="stat-box">Bot Uptime: <div class="stat-val" id="uptimeVal">-</div></div>
    </div>
  </div>

  <div class="card" id="playerUI" style="display:none;">
    <h2>Now Playing (Echtzeit)</h2>
    
    <div style="margin-bottom: 20px; text-align:center;">
       <label>Aktiver Server:</label>
       <select id="serverSelect" onchange="changeServer()"></select>
    </div>

    <div class="player-ui">
      <h3 id="npTitle">W√§hle einen Server...</h3>
      <div id="npAuthor" style="color:#94a3b8"></div>
      <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
      <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.8rem;">
        <span id="currTime">0:00</span><span id="totTime">0:00</span>
      </div>
    </div>
  </div>

  <div class="card" id="controlsUI" style="display:none;">
    <h2>Steuerung</h2>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
       <input type="text" id="playUrl" placeholder="YouTube / Spotify Link" style="flex:1;">
       <button onclick="control('play')">Play</button>
    </div>
    <div style="display:flex; gap:10px;">
       <button onclick="control('skip')" style="background:#3b82f6">Skip</button>
       <button onclick="control('stop')" style="background:#ef4444">Stop</button>
    </div>
    
    <h3 style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">Einstellungen</h3>
    <label>Standard Voice Channel:</label>
    <select id="voiceSelect"></select>
    <button onclick="saveSettings()" style="margin-top:5px; font-size:0.8rem;">Speichern</button>
  </div>

  <div class="card" id="logUI" style="display:none;">
    <h2>Logs</h2>
    <textarea id="logArea" readonly></textarea>
  </div>
</div>

<script>
let token = "";
let currentGid = "";
let playerInterval = null;

function login() {
  token = document.getElementById('apiKey').value;
  if(!token) return alert("PW fehlt");
  fetch('/api/status', { headers: { 'x-api-key': token } })
    .then(r => { if(r.status===401) throw new Error("Falsches PW"); return r.json(); })
    .then(data => {
      document.getElementById('loginArea').style.display='none';
      document.getElementById('statusArea').style.display='block';
      ['mainUI','playerUI','controlsUI','logUI'].forEach(id=>document.getElementById(id).style.display='block');
      
      updateStats(data.system);
      fillServerList(data.guilds);
      
      setInterval(loadStats, 5000);
      setInterval(loadLogs, 3000);
      startPlayerLoop();
    })
    .catch(e=>alert(e.message));
}

function fillServerList(guilds) {
  const sel = document.getElementById('serverSelect');
  sel.innerHTML = '<option value="">-- W√§hlen --</option>';
  guilds.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.id; opt.innerText = g.name;
    sel.appendChild(opt);
  });
}

function changeServer() {
  currentGid = document.getElementById('serverSelect').value;
  if(!currentGid) return;
  loadGuildDetails();
  updatePlayer();
}

function loadGuildDetails() {
  fetch(`/api/guilds/${currentGid}/details`, { headers: { 'x-api-key': token } })
    .then(r=>r.json())
    .then(d => {
       const vsel = document.getElementById('voiceSelect');
       vsel.innerHTML = '';
       d.voiceChannels.forEach(c => {
         const opt = document.createElement('option');
         opt.value = c.id; opt.innerText = c.name;
         vsel.appendChild(opt);
       });
       if(d.settings.voiceChannelId) vsel.value = d.settings.voiceChannelId;
    });
}

function control(action) {
  if(!currentGid) return alert("Erst Server w√§hlen!");
  
  if(action === 'play') {
    const query = document.getElementById('playUrl').value;
    fetch(`/api/guilds/${currentGid}/play`, {
       method:'POST', headers:{'x-api-key':token, 'Content-Type':'application/json'},
       body: JSON.stringify({query})
    }).then(r=>r.json()).then(d=>{
       if(d.error) alert(d.error);
       else { document.getElementById('playUrl').value=''; alert("Gestartet: "+d.track); }
    });
  } else {
    fetch(`/api/guilds/${currentGid}/${action}`, {
       method:'POST', headers:{'x-api-key':token}
    });
  }
}

function saveSettings() {
  if(!currentGid) return;
  const vid = document.getElementById('voiceSelect').value;
  fetch(`/api/guilds/${currentGid}/settings`, {
     method:'POST', headers:{'x-api-key':token, 'Content-Type':'application/json'},
     body: JSON.stringify({ voiceChannelId: vid })
  }).then(()=>alert("Gespeichert"));
}

function loadStats() {
  fetch('/api/status', { headers: { 'x-api-key': token } }).then(r=>r.json()).then(d=>updateStats(d.system));
}
function updateStats(s) {
  document.getElementById('ramVal').innerText = s.ramUsed;
  document.getElementById('cpuVal').innerText = s.cpuLoad;
  document.getElementById('uptimeVal').innerText = s.uptime;
}
function loadLogs() {
  fetch('/api/logs', { headers: { 'x-api-key': token } }).then(r=>r.json()).then(d=>{
     const el=document.getElementById('logArea'); el.value=d.lines.join("\n"); el.scrollTop=el.scrollHeight;
  });
}

function startPlayerLoop() {
  if(playerInterval) clearInterval(playerInterval);
  playerInterval = setInterval(updatePlayer, 1000);
}
function updatePlayer() {
  if(!currentGid) return;
  fetch(`/api/np?guildId=${currentGid}`).then(r=>r.json()).then(d => {
    if(!d.playing) {
       document.getElementById('npTitle').innerText = "Pause / Leer";
       document.getElementById('progFill').style.width="0%";
       return;
    }
    document.getElementById('npTitle').innerText = d.title;
    document.getElementById('npAuthor').innerText = d.author;
    if(d.duration > 0) {
       const pct = (d.position / d.duration)*100;
       document.getElementById('progFill').style.width=pct+"%";
       document.getElementById('currTime').innerText=fmt(d.position);
       document.getElementById('totTime').innerText=fmt(d.duration);
    }
  });
}
function fmt(ms) {
  const s=Math.floor(ms/1000)%60, m=Math.floor(ms/1000/60);
  return `${m}:${s.toString().padStart(2,'0')}`;
}
</script>
</body>
</html>
