<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Nightwolf Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* NIGHTWOLF THEME */
    :root { --bg: #050505; --panel: #111111; --border: #330000; --primary: #ff0033; --accent: #ffcc00; --text: #e0e0e0; --text-muted: #888; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-image: radial-gradient(circle at top right, #330000 0%, transparent 40%); }
    .container { max-width: 1000px; margin: 0 auto; display: grid; gap: 25px; }
    .card { background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    h1, h2, h3 { margin-top: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
    h1 { font-size: 1.8rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .stat-box { background: #000; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #220000; }
    .stat-val { font-size: 1.4rem; font-weight: bold; color: var(--accent); margin-top: 5px; }

    .player-ui { text-align: center; padding: 10px 0; }
    #npTitle { font-size: 1.3rem; color: #fff; margin-bottom: 5px; }
    #npAuthor { color: var(--accent); font-weight: bold; }
    .progress-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin-top: 15px; overflow: hidden; border: 1px solid #444; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s linear; }

    input, button, select { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; font-size: 1rem; outline: none; }
    button { background: var(--primary); border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; box-shadow: 0 4px 0 #990000; }
    button:active { transform: translateY(4px); box-shadow: none; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.stop-btn { background: #333; box-shadow: 0 4px 0 #111; }
    
    /* Autoplay List Styling */
    #apList { list-style: none; padding: 0; margin-top: 15px; max-height: 150px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; }
    #apList li { padding: 8px 12px; border-bottom: 1px solid #222; background: #0a0a0a; display: flex; justify-content: space-between; font-size: 0.9rem; }
    #apList li:last-child { border-bottom: none; }
    
    textarea { width: 100%; height: 200px; background: #050505; color: var(--accent); border: 1px solid #333; padding: 10px; font-family: monospace; border-radius: 8px; }
    .status-dot { display: inline-block; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); margin-right: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div class="card" style="display: flex; justify-content: space-between; align-items: center; border-color: var(--primary);">
    <div><h1 style="border:none; margin:0;">üê∫ Nightwolf Admin</h1></div>
    <div id="loginArea">
      <input type="password" id="apiKey" placeholder="Passwort" />
      <button onclick="login()">Login</button>
    </div>
    <div id="statusArea" style="display:none; color: var(--accent); font-weight: bold;">
      <span class="status-dot"></span> Verbunden
    </div>
  </div>

  <div class="card" id="mainUI" style="display:none;">
    <h2>System Status</h2>
    <div class="stats-grid">
      <div class="stat-box">Bot RAM <div class="stat-val" id="ramVal">-</div></div>
      <div class="stat-box">CPU Load <div class="stat-val" id="cpuVal">-</div></div>
      <div class="stat-box">Uptime <div class="stat-val" id="uptimeVal">-</div></div>
    </div>
  </div>

  <div class="card" id="playerUI" style="display:none;">
    <h2>üéß Live Control</h2>
    <div style="margin-bottom: 25px; text-align:center;">
       <label style="color:var(--text-muted);">Server w√§hlen:</label>
       <select id="serverSelect" onchange="changeServer()" style="width:100%; max-width:400px; border-color:var(--primary);">
          <option value="">-- Bitte w√§hlen --</option>
       </select>
       <button onclick="refreshServers()" style="padding:12px; width:auto; margin-left:5px;">üîÑ</button>
    </div>
    <div class="player-ui">
      <h3 id="npTitle">Leerlauf</h3>
      <div id="npAuthor"></div>
      <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
      <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:0.9rem; color:var(--text-muted);">
        <span id="currTime">0:00</span><span id="totTime">0:00</span>
      </div>
    </div>
  </div>

  <div class="card" id="controlsUI" style="display:none;">
    <h2>Steuerung</h2>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
       <input type="text" id="playUrl" placeholder="Link eingeben..." style="flex:1;">
       <button onclick="control('play')">‚ñ∂ Play</button>
    </div>
    <div style="display:flex; gap:15px; justify-content: center; margin-bottom:30px;">
       <button style="width:100px;" onclick="control('skip')">‚è≠ Skip</button>
       <button style="width:100px;" class="stop-btn" onclick="control('stop')">‚èπ Stop</button>
    </div>

    <div style="border-top:1px solid #333; padding-top:20px;">
        <h2>‚ôæÔ∏è Autoplay Liste</h2>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="apUrl" placeholder="YouTube/Spotify Link f√ºr Autoplay..." style="flex:1;">
            <button onclick="addAutoplay()" style="width:auto;">Add</button>
            <button onclick="clearAutoplay()" class="stop-btn" style="width:auto;">Clear</button>
        </div>
        <ul id="apList"></ul>
    </div>
    
    <div style="border-top:1px solid #333; padding-top:20px; margin-top:20px;">
        <h3 style="font-size:1rem; color:var(--text-muted);">Settings</h3>
        <div style="display:flex; gap:10px;">
            <select id="voiceSelect" style="flex:1;"></select>
            <button onclick="saveSettings()" class="stop-btn" style="width:auto;">Save</button>
        </div>
    </div>
  </div>

  <div class="card" id="logUI" style="display:none;">
    <h2>Logs</h2>
    <textarea id="logArea" readonly></textarea>
  </div>
</div>

<script>
let token="", currentGid="", playerInterval=null;

function login(){
  token=document.getElementById('apiKey').value;
  if(!token) return alert("PW fehlt");
  fetch('/api/status',{headers:{'x-api-key':token}}).then(r=>{if(r.status===401)throw new Error("Falsches PW");return r.json()})
  .then(d=>{
    document.getElementById('loginArea').style.display='none';
    document.getElementById('statusArea').style.display='block';
    ['mainUI','playerUI','controlsUI','logUI'].forEach(id=>document.getElementById(id).style.display='block');
    updateStats(d.system); fillServerList(d.guilds);
    setInterval(loadStats,5000); setInterval(loadLogs,3000); startPlayerLoop();
  }).catch(e=>alert(e.message));
}

function refreshServers(){ fetch('/api/status',{headers:{'x-api-key':token}}).then(r=>r.json()).then(d=>fillServerList(d.guilds)); }
function fillServerList(g){
  const s=document.getElementById('serverSelect'), old=s.value; s.innerHTML='<option value="">-- W√§hlen --</option>';
  if(!g||!g.length) return;
  g.forEach(x=>{ let o=document.createElement('option'); o.value=x.id; o.innerText=x.name; s.appendChild(o); });
  if(old) s.value=old;
}

function changeServer(){
  currentGid=document.getElementById('serverSelect').value;
  document.getElementById('apList').innerHTML = ''; 
  if(!currentGid) return;
  loadGuildDetails(); updatePlayer(); loadAutoplay(); 
}

function loadGuildDetails(){
  fetch(`/api/guilds/${currentGid}/details`,{headers:{'x-api-key':token}}).then(r=>r.json()).then(d=>{
    const v=document.getElementById('voiceSelect'); v.innerHTML='<option value="">-- Voice --</option>';
    d.voiceChannels.forEach(c=>{ let o=document.createElement('option'); o.value=c.id; o.innerText=c.name; v.appendChild(o); });
    if(d.settings.voiceChannelId) v.value=d.settings.voiceChannelId;
  });
}

function loadAutoplay() {
    if(!currentGid) return;
    fetch(`/api/autoplay/${currentGid}`, {headers:{'x-api-key':token}})
    .then(r=>r.json()).then(d => renderAutoplayList(d.list));
}
function addAutoplay() {
    const url = document.getElementById('apUrl').value;
    if(!url || !currentGid) return;
    fetch(`/api/autoplay/${currentGid}/add`, {
        method:'POST', headers:{'x-api-key':token, 'Content-Type':'application/json'}, body:JSON.stringify({url})
    }).then(r=>r.json()).then(d => {
        document.getElementById('apUrl').value = '';
        renderAutoplayList(d.list);
    });
}
function clearAutoplay() {
    if(!currentGid) return;
    fetch(`/api/autoplay/${currentGid}/clear`, {method:'POST', headers:{'x-api-key':token}})
    .then(r=>r.json()).then(d => renderAutoplayList(d.list));
}
function renderAutoplayList(list) {
    const ul = document.getElementById('apList');
    ul.innerHTML = '';
    if(!list || !list.length) { ul.innerHTML = '<li style="color:#666">Liste leer</li>'; return; }
    list.forEach((u, i) => {
        const li = document.createElement('li');
        li.innerText = `${i+1}. ${u}`;
        ul.appendChild(li);
    });
}

function control(action){
  if(!currentGid) return alert("Server w√§hlen!");
  if(action==='play'){
    const q=document.getElementById('playUrl').value;
    fetch(`/api/guilds/${currentGid}/play`,{method:'POST',headers:{'x-api-key':token,'Content-Type':'application/json'},body:JSON.stringify({query:q})})
    .then(r=>r.json()).then(d=>{ if(d.error)alert(d.error); else{document.getElementById('playUrl').value=''; updatePlayer();} });
  } else {
    fetch(`/api/guilds/${currentGid}/${action}`,{method:'POST',headers:{'x-api-key':token}}).then(()=>setTimeout(updatePlayer,500));
  }
}

function saveSettings(){
  if(!currentGid)return;
  const v=document.getElementById('voiceSelect').value;
  fetch(`/api/guilds/${currentGid}/settings`,{method:'POST',headers:{'x-api-key':token,'Content-Type':'application/json'},body:JSON.stringify({voiceChannelId:v})}).then(()=>alert("Gespeichert"));
}

function loadStats(){ fetch('/api/status',{headers:{'x-api-key':token}}).then(r=>r.json()).then(d=>updateStats(d.system)); }
function updateStats(s){ if(!s)return; document.getElementById('ramVal').innerText=s.ramUsed; document.getElementById('cpuVal').innerText=s.cpuLoad; document.getElementById('uptimeVal').innerText=s.uptime; }
function loadLogs(){ 
    fetch('/api/logs',{headers:{'x-api-key':token}}).then(r=>r.json()).then(d=>{
        const el=document.getElementById('logArea'); 
        const scroll=el.scrollTop+el.clientHeight>=el.scrollHeight-50; 
        el.value=d.lines.join("\n"); if(scroll)el.scrollTop=el.scrollHeight; 
    }); 
}

function startPlayerLoop(){ if(playerInterval)clearInterval(playerInterval); playerInterval=setInterval(updatePlayer,1000); }
function updatePlayer(){
  if(!currentGid)return;
  fetch(`/api/np?guildId=${currentGid}`).then(r=>r.json()).then(d=>{
    const t=document.getElementById('npTitle'), a=document.getElementById('npAuthor'), b=document.getElementById('progFill');
    if(!d.playing){ t.innerText="Leerlauf"; t.style.color="#888"; a.innerText=""; b.style.width="0%"; return; }
    t.innerText=d.title; t.style.color="#fff"; a.innerText=d.author;
    if(d.duration>0){ b.style.width=Math.min((d.position/d.duration)*100,100)+"%"; document.getElementById('currTime').innerText=fmt(d.position); document.getElementById('totTime').innerText=fmt(d.duration); }
  }).catch(()=>{});
}
function fmt(ms){ if(!ms)return"0:00"; const s=Math.floor(ms/1000)%60, m=Math.floor(ms/1000/60); return`${m}:${s.toString().padStart(2,'0')}`; }
</script>
</body>
</html>
