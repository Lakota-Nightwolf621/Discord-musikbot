<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Nightwolf Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { --bg: #0f172a; --panel: #1e293b; --accent: #ec4899; --text: #f1f5f9; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; display: grid; gap: 20px; }
    .card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
    h2 { margin-top: 0; color: var(--accent); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .stat-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: #38bdf8; }
    
    .player-ui { text-align: center; }
    .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s linear; }
    
    input, button { padding: 10px; border-radius: 6px; border: none; }
    input { background: #0f172a; color: white; border: 1px solid #475569; width: 200px; }
    button { background: var(--accent); color: white; cursor: pointer; font-weight: bold; }
    button:disabled { opacity: 0.5; }
    
    textarea { width: 100%; height: 300px; background: #000; color: #0f0; border: none; padding: 10px; font-family: monospace; }
  </style>
</head>
<body>

<div class="container">
  <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>üê∫ Nightwolf Entertainments</h1>
    <div id="loginArea">
      <input type="password" id="apiKey" placeholder="Passwort" />
      <button onclick="login()">Login</button>
    </div>
    <div id="statusArea" style="display:none; text-align:right;">
      <span style="color:#4ade80">‚óè Verbunden</span>
    </div>
  </div>

  <div class="card" id="statsCard" style="display:none;">
    <h2>System Auslastung</h2>
    <div class="stats-grid">
      <div class="stat-box">RAM: <div class="stat-val" id="ramVal">-</div></div>
      <div class="stat-box">CPU Load: <div class="stat-val" id="cpuVal">-</div></div>
      <div class="stat-box">Uptime: <div class="stat-val" id="uptimeVal">-</div></div>
    </div>
  </div>

  <div class="card" id="playerCard" style="display:none;">
    <h2>Now Playing (Live)</h2>
    <div class="player-ui">
      <h3 id="npTitle">Nichts wird abgespielt</h3>
      <div id="npAuthor" style="color:#94a3b8"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progFill"></div>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.8rem;">
        <span id="currTime">0:00</span>
        <span id="totTime">0:00</span>
      </div>
    </div>
    <div style="margin-top: 20px;">
        <label>Server ID √ºberwachen:</label>
        <input type="text" id="guildId" placeholder="Discord Server ID" onchange="startPlayerLoop()">
    </div>
  </div>

  <div class="card" id="logsCard" style="display:none;">
    <h2>System Logs</h2>
    <textarea id="logArea" readonly></textarea>
  </div>
</div>

<script>
let token = "";
let playerInterval = null;

function login() {
  token = document.getElementById('apiKey').value;
  if(!token) return alert("Passwort fehlt!");
  
  // Test Auth
  fetch('/api/status', { headers: { 'x-api-key': token } })
    .then(r => {
      if(r.status === 401) throw new Error("Falsches Passwort");
      return r.json();
    })
    .then(data => {
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('statusArea').style.display = 'block';
      document.getElementById('statsCard').style.display = 'block';
      document.getElementById('playerCard').style.display = 'block';
      document.getElementById('logsCard').style.display = 'block';
      
      updateStats(data.system);
      setInterval(loadStats, 5000); // Alle 5s System Stats
      setInterval(loadLogs, 3000);  // Alle 3s Logs
    })
    .catch(e => alert(e.message));
}

function loadStats() {
  fetch('/api/status', { headers: { 'x-api-key': token } })
    .then(r => r.json())
    .then(d => updateStats(d.system));
}

function updateStats(s) {
  if(!s) return;
  document.getElementById('ramVal').innerText = s.ramUsed;
  document.getElementById('cpuVal').innerText = s.cpuLoad;
  document.getElementById('uptimeVal').innerText = s.uptime;
}

function loadLogs() {
  fetch('/api/logs', { headers: { 'x-api-key': token } })
    .then(r => r.json())
    .then(d => {
       const el = document.getElementById('logArea');
       el.value = d.lines.join("\n");
       el.scrollTop = el.scrollHeight;
    });
}

// Echtzeit Player Update (l√§uft √∂fter: jede Sekunde)
function startPlayerLoop() {
  if(playerInterval) clearInterval(playerInterval);
  playerInterval = setInterval(updatePlayer, 1000);
  updatePlayer();
}

function updatePlayer() {
  const gid = document.getElementById('guildId').value;
  if(!gid) return;

  fetch(`/api/np?guildId=${gid}`)
    .then(r => r.json())
    .then(d => {
      if(!d.playing) {
        document.getElementById('npTitle').innerText = "Pause / Leer";
        document.getElementById('progFill').style.width = "0%";
        return;
      }
      document.getElementById('npTitle').innerText = d.title;
      document.getElementById('npAuthor').innerText = d.author;
      
      if(d.duration > 0) {
        const pct = (d.position / d.duration) * 100;
        document.getElementById('progFill').style.width = pct + "%";
        document.getElementById('currTime').innerText = fmt(d.position);
        document.getElementById('totTime').innerText = fmt(d.duration);
      }
    });
}

function fmt(ms) {
  const s = Math.floor(ms / 1000) % 60;
  const m = Math.floor(ms / 1000 / 60);
  return `${m}:${s.toString().padStart(2,'0')}`;
}
</script>
</body>
</html>
